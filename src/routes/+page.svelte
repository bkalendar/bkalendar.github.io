<script lang="ts">
	import Key from '$lib/Key.svelte';

	import { goto } from '$app/navigation';
	import { parseStudent, resolve, type Timetable } from '@bkalendar/core';

	import OkeeButton from '$lib/OkeeButton.svelte';
	import { getTimetableCtx } from '$lib/timetable';
	import type { PageData } from './$types';

	export let data: PageData;

	let raw: string = '';
	let timetable: Required<Timetable> | null = null;
	$: if (raw) {
		const t = parseStudent(raw);
		resolve(t);
		timetable = t;
	}

	// store in context for subsequent client-side page access
	const timetableCtx = getTimetableCtx();
	$: if (timetable !== null) {
		timetableCtx.set(timetable);
	}

	async function addHandler() {
		await data.db.add(timetable!);
		await goto('/export');
	}
</script>

<div class="mx-auto w-full max-w-md px-5 pt-10">
	<h1 class="text-5xl font-bold tracking-tighter">
		<span class="bg-gradient-to-br from-sky-500 to-marine-300 bg-clip-text text-transparent">
			BK</span
		>alendar
	</h1>
	<p class="text-right">vì bạn xứng đáng có một bộ lịch đẹp 🌹</p>

	<textarea
		class="mt-5 h-32 w-full rounded bg-transparent p-2
			text-xs placeholder-slate-400
			outline-dashed outline-[1.5px] outline-slate-200 focus:outline-slate-500"
		placeholder="> ctrl+A trang stinfo rồi paste vào đây"
		bind:value={raw}
	/>

	<details open={timetable === null}>
		<summary class="my-2 rounded bg-slate-50 px-2 py-1 font-bold text-slate-600"
			>📙 hướng dẫn chi tiết</summary
		>

		<ol class="list-inside list-decimal space-y-2">
			<li>
				vào <a
					href="https://mybk.hcmut.edu.vn/stinfo/"
					target="_blank"
					class="font-mono text-sky-500 underline">mybk/stinfo</a
				>;
			</li>
			<li>
				bấm vào ô <span class="text-sky-500"
					>thời khóa biểu <img
						src="https://mybk.hcmut.edu.vn/stinfo/public/uploads/avatars/1477389315-calendar-1.png"
						alt="thời khóa biểu"
						class="inline h-5 w-5"
					/></span
				>;
			</li>
			<li>
				nhấn <Key>Ctrl/⌘</Key>
				<Key>A</Key> rồi <Key>Ctrl/⌘</Key>
				<Key>C</Key> để copy thời khóa biểu (yes, <em>toàn bộ</em> trang luôn);
			</li>
			<li><Key>Ctrl/⌘</Key> <Key>V</Key> vào khung bên trên.</li>
			<li>đến lúc <em>Okee</em> rồi</li>
		</ol>
	</details>

	<div class="mt-2 flex justify-end space-x-2">
		<OkeeButton disabled={timetable === null} on:click={addHandler} />
	</div>
</div>
